<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Kehadiran</title>

<!-- BOOTSTRAP -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- CHART -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  background: linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
}
.card{
  border-radius:18px;
  box-shadow:0 8px 25px rgba(0,0,0,.25);
}
.chart-wrapper{
  height:320px;
  position:relative;
}
.loading-overlay{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,.8);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
  border-radius:12px;
}
</style>
</head>

<body>
<div class="container py-4">

<!-- HEADER -->
<div class="text-center text-white mb-4">
  <h2><i class="bi bi-bar-chart-fill"></i> Dashboard Kehadiran</h2>
  <p class="opacity-75">Statistik Kehadiran Pegawai</p>
</div>

<!-- GRAFIK 1-->
<div class="card p-4 mb-4">
  <h5><i class="bi bi-graph-up"></i> Grafik Kehadiran</h5>

  <div class="chart-wrapper">
    <div id="chartLoading" class="loading-overlay">
      <div class="spinner-border text-primary"></div>
    </div>
    <canvas id="chart"></canvas>
  </div>
</div>


<!-- GRAFIK 2 -->
<div class="card p-4 mb-4">
  <h5><i class="bi bi-calendar3"></i> Rekap Kehadiran Bulanan</h5>

  <div class="chart-wrapper">
    <div id="chartBulanLoading" class="loading-overlay">
      <div class="spinner-border text-primary"></div>
    </div>
    <canvas id="chartBulan"></canvas>
  </div>
</div>

<!-- TOMBOL TAMBAH -->
<div class="text-end mb-3">
  <button class="btn btn-warning btn-lg" onclick="openPasswordModal()">
    <i class="bi bi-plus-circle"></i> Tambah Data
  </button>
</div>

<!-- MODAL PASSWORD -->
<div class="modal fade" id="passwordModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title">Verifikasi Password</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
    <input type="password" id="password" class="form-control" placeholder="Masukkan password">
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary w-100" onclick="checkPassword()">Lanjut</button>
  </div>
</div>
</div>
</div>

<!-- MODAL FORM -->
<div class="modal fade" id="formModal" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-centered">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title">Tambah Data Kehadiran</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>

  <div class="modal-body">
    <div class="row g-3">
      <div class="col-md-4">
        <select id="nama" class="form-select">
          <option value="">-- Pilih Nama --</option>
          <option>Aziz Baskoro</option>
          <option>Andreas</option>
          <option>Asep Tofandi</option>
          <option>Ahmad Rifai</option>
          <option>Bayu Dwi Prasetyo</option>
          <option>Denny</option>
          <option>Isnan Vany</option>
          <option>Joko Prabowo</option>
          <option>Muhammad Hendar</option>
          <option>Muhammad Ridwan</option>
          <option>Rusnita</option>
          <option>Silma</option>
          <option>Sony Arman</option>
          <option>Syahendry</option>
        </select>
      </div>
      <div class="col-md-4">
        <input type="date" id="tanggal" class="form-control">
      </div>
      <div class="col-md-4">
        <select id="keterangan" class="form-select">
          <option value="">-- Keterangan --</option>
          <option>cuti</option>
          <option>sakit</option>
          <option>izin</option>
          <option>telat</option>
        </select>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button id="btnSimpan" class="btn btn-success w-100" onclick="kirimData()">
      Simpan
    </button>
  </div>
</div>
</div>
</div>

<!-- MODAL SUCCESS -->
<div class="modal fade" id="successModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content text-center p-4">
  <i class="bi bi-check-circle-fill text-success fs-1 mb-3"></i>
  <h5>Data berhasil dikirim!</h5>
  <button class="btn btn-success mt-3" data-bs-dismiss="modal">OK</button>
</div>
</div>
</div>

<!-- TABEL -->
<div class="card p-4 position-relative">
  <div id="tableLoading" class="loading-overlay">
    <div class="spinner-border text-primary"></div>
  </div>
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Nama</th>
        <th>Tanggal</th>
        <th>Bulan</th>
        <th>Keterangan</th>
      </tr>
    </thead>
    <tbody id="tableData"></tbody>
  </table>
</div>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyZIE0B9kLP6SQbG1ibfYHc4mmhMGEVL_pCnLEm1e67uan2vb8G9tjfQi3UkftrvnmB/exec";
const PASSWORD="hcc2026";
let chartInstance;
let chartBulanInstance;


const passwordModal=new bootstrap.Modal(passwordModalEl=document.getElementById("passwordModal"));
const formModal=new bootstrap.Modal(formModalEl=document.getElementById("formModal"));
const successModal=new bootstrap.Modal(document.getElementById("successModal"));



document.addEventListener("DOMContentLoaded",loadData);

/* MODAL */
function openPasswordModal(){
  password.value="";
  passwordModal.show();
}
function checkPassword(){
  if(password.value===PASSWORD){
    passwordModal.hide();
    formModal.show();
  }else alert("Password salah!");
}

/* SIMPAN DATA + LOADING */
function kirimData(){
  if(!nama.value || !tanggal.value || !keterangan.value){
    alert("Semua field wajib diisi!");
    return;
  }

  btnSimpan.disabled=true;
  btnSimpan.innerHTML=`<span class="spinner-border spinner-border-sm"></span> Mengirim...`;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      nama:nama.value,
      tanggal:tanggal.value,
      keterangan:keterangan.value
    })
  }).then(()=>{
    formModal.hide();
    successModal.show();
    btnSimpan.disabled=false;
    btnSimpan.innerHTML="Simpan";
    loadData();
  });
}

/* LOAD DATA + LOADING */
function loadData(){
  chartLoading.style.display="flex";
  chartBulanLoading.style.display="flex";
  tableLoading.style.display="flex";

  fetch(API_URL)
    .then(r=>r.json())
    .then(data=>{
      renderChart(data);
      renderChartBulanan(data);
      renderTable(data);

      chartLoading.style.display="none";
      chartBulanLoading.style.display="none";
      tableLoading.style.display="none";
    });
}


/* GRAFIK */
function renderChart(data){
  const namaList=[...new Set(data.map(d=>d.nama))];
  const jenis=["cuti","sakit","izin","telat"];
  const warna={cuti:"#28a745",sakit:"#fd7e14",izin:"#0d6efd",telat:"#dc3545"};
  const rekap={};

  namaList.forEach(n=>rekap[n]={cuti:0,sakit:0,izin:0,telat:0});
  data.forEach(d=>rekap[d.nama][d.keterangan]++);

  const datasets=jenis.map(j=>({
    label:j.toUpperCase(),
    data:namaList.map(n=>rekap[n][j]),
    backgroundColor:warna[j],
    stack:"kehadiran"
  }));

  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(chart,{
    type:"bar",
    data:{labels:namaList,datasets},
    options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}}
  });
}

function renderChartBulanan(data){
  if(!Array.isArray(data)) return;

  const bulanNama=[
    "Januari","Februari","Maret","April","Mei","Juni",
    "Juli","Agustus","September","Oktober","November","Desember"
  ];

  const jenis=["cuti","sakit","izin","telat"];
  const warna={
    cuti:"#28a745",
    sakit:"#fd7e14",
    izin:"#0d6efd",
    telat:"#dc3545"
  };

  // INIT REKAP BULAN
  const rekapBulanan={};
  bulanNama.forEach(b=>{
    rekapBulanan[b]={cuti:0,sakit:0,izin:0,telat:0};
  });

  // HITUNG DATA
  data.forEach(d=>{
    const bulanIndex=parseInt(d.tanggal.split("-")[1])-1;
    const bulan=bulanNama[bulanIndex];
    rekapBulanan[bulan][d.keterangan]++;
  });

  const datasets=jenis.map(j=>({
    label:j.toUpperCase(),
    data:bulanNama.map(b=>rekapBulanan[b][j]),
    backgroundColor:warna[j],
    stack:"bulan"
  }));

  if(chartBulanInstance) chartBulanInstance.destroy();

  chartBulanInstance=new Chart(chartBulan,{
    type:"bar",
    data:{
      labels:bulanNama,
      datasets
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ stacked:true },
        y:{ stacked:true, beginAtZero:true }
      }
    }
  });
}

/* TABEL */
function renderTable(data){
  tableData.innerHTML="";
  const bulan=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
  data.forEach(d=>{
    const [,b]=d.tanggal.split("-");
    tableData.innerHTML+=`
      <tr>
        <td>${d.nama}</td>
        <td>${d.tanggal}</td>
        <td>${bulan[b-1]}</td>
        <td>${d.keterangan}</td>
      </tr>`;
  });
}



</script>
</body>
</html>
