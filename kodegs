function doGet(e) {
  const callback = e.parameter.callback;
  const data = getData();

  if (callback) {
    return ContentService
      .createTextOutput(callback + '(' + JSON.stringify(data) + ')')
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }

  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function getData() {
  const sheet = SpreadsheetApp.getActive().getSheetByName("DATA");
  const values = sheet.getDataRange().getValues();

  const bulanValid = [
    "Januari","Februari","Maret","April","Mei","Juni",
    "Juli","Agustus","September","Oktober","November","Desember"
  ];

  let perBulan = {};
  let rows = [];

  for (let i = 1; i < values.length; i++) {

    let nama = values[i][0];

    // NORMALISASI BULAN (INI KUNCI UTAMA)
    let rawBulan = values[i][1].toString().trim().toLowerCase();
    let bulan = bulanValid.find(b => b.toLowerCase() === rawBulan);
    if (!bulan) continue; // skip jika bulan tidak valid

    let izin = Number(values[i][2]) || 0;
    let sakit = Number(values[i][3]) || 0;
    let cuti = Number(values[i][4]) || 0;
    let telat = Number(values[i][5]) || 0;

    let hariKerja = 22;
    let totalAbsen = izin + sakit + cuti;
    let performa = Math.round(((hariKerja - totalAbsen) / hariKerja) * 100);

    // DATA TABEL
    rows.push({
      nama,
      bulan,
      izin,
      sakit,
      cuti,
      telat,
      performa
    });

    // SUMMARY CARD PER BULAN
    if (!perBulan[bulan]) {
      perBulan[bulan] = { izin: 0, sakit: 0, cuti: 0, telat:0, };
    }

    perBulan[bulan].izin += izin;
    perBulan[bulan].sakit += sakit;
    perBulan[bulan].cuti += cuti;
    perBulan[bulan].telat += telat;
  }

  return {
    perBulan,
    data: rows
  };
}
